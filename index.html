<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flambeau River Ramble - Group Packing Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .person-card {
            transition: all 0.3s ease;
        }
        .person-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-fill {
            transition: stroke-dashoffset 0.3s ease;
        }
        .item-row {
            transition: all 0.2s ease;
        }
        .item-row:hover {
            background-color: #f8fafc;
        }
        .category-section {
            border-left: 4px solid #e5e7eb;
            padding-left: 1rem;
            margin-bottom: 1.5rem;
        }
        .category-section.required {
            border-left-color: #ef4444;
        }
        .category-section.highlyRecommended {
            border-left-color: #f59e0b;
        }
        .category-section.optional {
            border-left-color: #10b981;
        }
        .category-section.forBase {
            border-left-color: #3b82f6;
        }
        .realtime-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">ðŸ›¶ Flambeau River Ramble</h1>
            <p class="text-xl text-gray-600">Group Packing Checklist</p>
            <p class="text-sm text-gray-500 mt-2">Pack smart, paddle together!</p>
        </div>

        <!-- Connection Status -->
        <div id="connectionStatus" class="max-w-md mx-auto mb-4 p-3 bg-yellow-100 border border-yellow-400 rounded-lg text-center text-sm text-yellow-800 hidden">
            <span id="statusText">Connecting to Firebase...</span>
        </div>

        <!-- Name Input -->
        <div id="nameInput" class="max-w-md mx-auto mb-8 p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Enter Your Name to Get Started</h2>
            <input 
                type="text" 
                id="userName" 
                placeholder="Your name..." 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                onkeypress="if(event.key==='Enter') setUserName()"
            >
            <button 
                onclick="setUserName()" 
                class="w-full mt-4 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors"
            >
                Join Group
            </button>
            <div class="flex items-center justify-center mt-4 text-xs text-gray-500">
                <div class="w-2 h-2 bg-green-500 rounded-full mr-2 realtime-indicator"></div>
                Real-time sync with group members
            </div>
        </div>

        <!-- Main App (hidden initially) -->
        <div id="mainApp" class="hidden">
            <!-- Current User Section -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">Your Checklist</h2>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center text-xs text-gray-500">
                            <div id="syncIndicator" class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                            <span id="syncStatus">Synced</span>
                        </div>
                        <button 
                            onclick="changeUser()" 
                            class="text-sm text-blue-600 hover:text-blue-800 underline"
                        >
                            Change Name
                        </button>
                    </div>
                </div>
                <div id="userProgress" class="bg-white rounded-lg shadow-md p-6">
                    <!-- User's checklist will be populated here -->
                </div>
            </div>

            <!-- Group Overview -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">Group Progress</h2>
                    <div class="text-sm text-gray-500">
                        <span id="groupMemberCount">0</span> member(s) online
                    </div>
                </div>
                <div id="groupOverview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Group member cards will be populated here -->
                </div>
            </div>

            <!-- Detailed View -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Detailed View</h2>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="mb-4">
                        <select id="categoryFilter" onchange="updateDetailedView()" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">All Categories</option>
                            <option value="required">Required Items</option>
                            <option value="highlyRecommended">Highly Recommended</option>
                            <option value="optional">Optional Items</option>
                            <option value="forBase">For Base Camp</option>
                        </select>
                    </div>
                    <div id="detailedView">
                        <!-- Detailed comparison will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="text-center text-sm text-gray-500 mt-8">
                <p>Last updated: <span id="lastUpdated">Never</span></p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAoVdv14MTRh_tST3Mwa1X6LhhIWzfahKU",
            authDomain: "flambeau-packing-142ad.firebaseapp.com",
            databaseURL: "https://flambeau-packing-142ad-default-rtdb.firebaseio.com",
            projectId: "flambeau-packing-142ad",
            storageBucket: "flambeau-packing-142ad.firebasestorage.app",
            messagingSenderId: "219383298265",
            appId: "1:219383298265:web:9e8f3ceb3115d50d92a6c8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global variables
        let currentUser = '';
        let allUserData = {};
        let isConnected = false;
        let userDataRef = null;
        let allUsersRef = null;

        // Packing items data
        const packingItems = {
            required: [
                { id: 'rx_meds', text: 'Rx Medications (enough for whole week, original bottles)', note: 'Must show dosage and expiration dates' },
                { id: 'sleeping_bag', text: 'Sleeping Bag (rated to at least 35Â°F)', note: 'Loaners available' },
                { id: 'rain_jacket', text: 'Rain Jacket', note: 'Loaners available' },
                { id: 'rain_pants', text: 'Rain Pants', note: 'Loaners available' },
                { id: 'wet_shoes', text: 'Wet Shoes (close-toed)', note: 'Must strap securely - no flip flops or Crocs' }
            ],
            highlyRecommended: [
                { id: 'toothbrush', text: 'Toothbrush' },
                { id: 'toothpaste', text: 'Toothpaste' },
                { id: 'hygiene_products', text: 'Personal Hygiene Items (feminine products, etc.)' },
                { id: 'tshirt_1', text: 'T-shirt/Tank Top #1' },
                { id: 'tshirt_2', text: 'T-shirt/Tank Top #2' },
                { id: 'long_sleeve', text: 'Long-sleeved Shirt' },
                { id: 'warm_sweater', text: 'Warm Sweater (wool or synthetic fleece only - NO COTTON!)' },
                { id: 'pants_1', text: 'Quick-drying Pants #1' },
                { id: 'pants_2', text: 'Quick-drying Pants #2' },
                { id: 'wool_socks_1', text: 'Wool Socks - Pair #1' },
                { id: 'wool_socks_2', text: 'Wool Socks - Pair #2' },
                { id: 'underwear', text: 'Underwear (multiple pairs)' },
                { id: 'sun_hat', text: 'Brimmed Hat for Sun' },
                { id: 'warm_hat', text: 'Warm Stocking Hat' },
                { id: 'water_bottle', text: 'Water Bottle (32 oz with screw-on top)', note: 'Loaners available' },
                { id: 'headlamp', text: 'Headlamp/Flashlight' },
                { id: 'dry_shoes', text: 'Dry Shoes for Campsite' }
            ],
            optional: [
                { id: 'shorts_1', text: 'Shorts - Pair #1' },
                { id: 'shorts_2', text: 'Shorts - Pair #2' },
                { id: 'swimsuit', text: 'Swimsuit' },
                { id: 'daypack', text: 'Small Daypack or Fanny Pack' },
                { id: 'towel', text: 'Camping Towel (chamois, sarong)' },
                { id: 'sleeping_pad', text: 'Sleeping Pad', note: 'Loaners available' },
                { id: 'sunglasses', text: 'Sunglasses' },
                { id: 'card_game', text: 'Card Game' },
                { id: 'journal', text: 'Journal (wrapped in plastic!)' },
                { id: 'book', text: 'Book to Read (wrapped in plastic!)' },
                { id: 'camera', text: 'Camera (wrapped in plastic!)', note: 'Loaners available' }
            ],
            forBase: [
                { id: 'clean_clothes', text: 'Clean Clothes for Car Ride Home' },
                { id: 'toiletries', text: 'Toiletries for Shower After Trip' },
                { id: 'money', text: 'Money for Camp Store' }
            ]
        };

        // Initialize Firebase connection status monitoring
        function initializeFirebase() {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            statusElement.classList.remove('hidden');
            statusText.textContent = 'Connecting to Firebase...';

            // Monitor connection status
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                isConnected = snap.val() === true;
                updateConnectionStatus();
            });

            // Listen for all users data
            allUsersRef = database.ref('users');
            allUsersRef.on('value', (snapshot) => {
                const data = snapshot.val();
                allUserData = data || {};
                updateUI();
            });
        }

        // Update connection status UI
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const syncIndicator = document.getElementById('syncIndicator');
            const syncStatus = document.getElementById('syncStatus');

            if (isConnected) {
                statusElement.classList.add('hidden');
                if (syncIndicator) {
                    syncIndicator.className = 'w-2 h-2 bg-green-500 rounded-full mr-2';
                    syncStatus.textContent = 'Synced';
                }
            } else {
                statusElement.classList.remove('hidden');
                statusElement.className = 'max-w-md mx-auto mb-4 p-3 bg-red-100 border border-red-400 rounded-lg text-center text-sm text-red-800';
                statusText.textContent = 'Connection lost. Reconnecting...';
                if (syncIndicator) {
                    syncIndicator.className = 'w-2 h-2 bg-red-500 rounded-full mr-2';
                    syncStatus.textContent = 'Offline';
                }
            }
        }

        // Set user name
        function setUserName() {
            const nameInput = document.getElementById('userName');
            const name = nameInput.value.trim();
            if (name) {
                currentUser = name;
                document.getElementById('nameInput').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                initializeUser();
            }
        }

        // Change user
        function changeUser() {
            // Clean up Firebase listeners
            if (userDataRef) {
                userDataRef.off();
            }
            
            document.getElementById('nameInput').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('userName').value = '';
            currentUser = '';
            userDataRef = null;
        }

        // Initialize user data
        function initializeUser() {
            if (!currentUser) return;

            // Create reference to user's data
            userDataRef = database.ref(`users/${currentUser}`);

            // Check if user exists, if not create them
            userDataRef.once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    // Create new user with empty checklist
                    const emptyChecklist = {};
                    Object.keys(packingItems).forEach(category => {
                        packingItems[category].forEach(item => {
                            emptyChecklist[item.id] = false;
                        });
                    });

                    const userData = {
                        name: currentUser,
                        checklist: emptyChecklist,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP,
                        isOnline: true
                    };

                    userDataRef.set(userData);
                } else {
                    // Update online status
                    userDataRef.update({
                        isOnline: true,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });

            // Set up presence system
            userDataRef.child('isOnline').onDisconnect().set(false);
            userDataRef.child('lastSeen').onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
        }

        // Toggle item for current user
        function toggleItem(itemId) {
            if (!currentUser || !userDataRef) return;

            const syncIndicator = document.getElementById('syncIndicator');
            const syncStatus = document.getElementById('syncStatus');
            
            // Show syncing status
            syncIndicator.className = 'w-2 h-2 bg-yellow-500 rounded-full mr-2 realtime-indicator';
            syncStatus.textContent = 'Syncing...';

            // Get current value and toggle it
            const currentValue = allUserData[currentUser]?.checklist?.[itemId] || false;
            const newValue = !currentValue;

            // Update in Firebase
            userDataRef.child(`checklist/${itemId}`).set(newValue)
                .then(() => {
                    // Update last updated timestamp
                    userDataRef.child('lastUpdated').set(firebase.database.ServerValue.TIMESTAMP);
                    
                    // Reset sync indicator
                    syncIndicator.className = 'w-2 h-2 bg-green-500 rounded-full mr-2';
                    syncStatus.textContent = 'Synced';
                })
                .catch((error) => {
                    console.error('Error updating item:', error);
                    syncIndicator.className = 'w-2 h-2 bg-red-500 rounded-full mr-2';
                    syncStatus.textContent = 'Error';
                });
        }

        // Calculate progress
        function calculateProgress(checklist) {
            const totalItems = Object.keys(packingItems).reduce((total, category) => {
                return total + packingItems[category].length;
            }, 0);
            
            const checkedItems = Object.values(checklist || {}).filter(Boolean).length;
            return { checked: checkedItems, total: totalItems };
        }

        // Get category progress
        function getCategoryProgress(checklist, category) {
            const items = packingItems[category];
            const checkedCount = items.filter(item => checklist?.[item.id]).length;
            return { checked: checkedCount, total: items.length };
        }

        // Create progress ring SVG
        function createProgressRing(progress, size = 60) {
            const percentage = progress.total > 0 ? (progress.checked / progress.total) * 100 : 0;
            const radius = (size - 8) / 2;
            const circumference = 2 * Math.PI * radius;
            const strokeDashoffset = circumference - (percentage / 100) * circumference;
            
            return `
                <svg width="${size}" height="${size}" class="progress-ring">
                    <circle cx="${size/2}" cy="${size/2}" r="${radius}" 
                            fill="none" stroke="#e5e7eb" stroke-width="4"/>
                    <circle cx="${size/2}" cy="${size/2}" r="${radius}" 
                            fill="none" stroke="#10b981" stroke-width="4" 
                            stroke-dasharray="${circumference}" 
                            stroke-dashoffset="${strokeDashoffset}"
                            class="progress-ring-fill"/>
                </svg>
            `;
        }

        // Update UI
        function updateUI() {
            if (!currentUser) return;
            
            updateUserProgress();
            updateGroupOverview();
            updateDetailedView();
            updateLastUpdated();
            updateGroupMemberCount();
        }

        // Update group member count
        function updateGroupMemberCount() {
            const countElement = document.getElementById('groupMemberCount');
            if (countElement) {
                const onlineCount = Object.values(allUserData).filter(user => user.isOnline).length;
                countElement.textContent = onlineCount;
            }
        }

        // Update user progress
        function updateUserProgress() {
            const userDiv = document.getElementById('userProgress');
            const userData = allUserData[currentUser];
            
            if (!userData) {
                userDiv.innerHTML = '<div class="text-center text-gray-500">Loading...</div>';
                return;
            }
            
            const progress = calculateProgress(userData.checklist);
            
            let html = `
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            ${createProgressRing(progress, 80)}
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-sm font-bold text-gray-700">
                                    ${progress.total > 0 ? Math.round((progress.checked / progress.total) * 100) : 0}%
                                </span>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900">${currentUser}</h3>
                            <p class="text-gray-600">${progress.checked}/${progress.total} items packed</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Add categories
            Object.keys(packingItems).forEach(category => {
                const categoryProgress = getCategoryProgress(userData.checklist, category);
                const categoryName = formatCategoryName(category);
                
                html += `
                    <div class="category-section ${category} mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-medium text-gray-900">${categoryName}</h4>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600">${categoryProgress.checked}/${categoryProgress.total}</span>
                                <div class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-green-500 transition-all duration-300" 
                                         style="width: ${categoryProgress.total > 0 ? (categoryProgress.checked / categoryProgress.total) * 100 : 0}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2">
                `;
                
                packingItems[category].forEach(item => {
                    const isChecked = userData.checklist?.[item.id] || false;
                    html += `
                        <div class="item-row flex items-start space-x-3 p-3 rounded-lg border ${isChecked ? 'border-green-200 bg-green-50' : 'border-gray-200 hover:border-gray-300'}">
                            <input 
                                type="checkbox" 
                                ${isChecked ? 'checked' : ''} 
                                onchange="toggleItem('${item.id}')"
                                class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 mt-1 flex-shrink-0"
                            >
                            <label class="flex-1 text-sm cursor-pointer ${isChecked ? 'line-through text-gray-500' : 'text-gray-900'}"
                                   onclick="toggleItem('${item.id}')">
                                ${item.text}
                                ${item.note ? `<br><span class="text-xs text-blue-600 font-medium">${item.note}</span>` : ''}
                            </label>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            userDiv.innerHTML = html;
        }

        // Update group overview
        function updateGroupOverview() {
            const groupDiv = document.getElementById('groupOverview');
            let html = '';
            
            const userNames = Object.keys(allUserData).sort();
            
            userNames.forEach(userName => {
                const userData = allUserData[userName];
                const progress = calculateProgress(userData.checklist);
                const isCurrentUser = userName === currentUser;
                const isOnline = userData.isOnline;
                
                html += `
                    <div class="person-card bg-white rounded-lg shadow-md p-6 ${isCurrentUser ? 'border-2 border-blue-500' : ''}">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-2">
                                <h3 class="text-lg font-semibold text-gray-900">
                                    ${userName} ${isCurrentUser ? '(You)' : ''}
                                </h3>
                                <div class="w-2 h-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
                            </div>
                            <div class="relative">
                                ${createProgressRing(progress, 50)}
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-xs font-bold text-gray-700">
                                        ${progress.total > 0 ? Math.round((progress.checked / progress.total) * 100) : 0}%
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600 mb-3">
                            ${progress.checked}/${progress.total} items packed
                        </div>
                        <div class="space-y-2">
                `;
                
                Object.keys(packingItems).forEach(category => {
                    const categoryProgress = getCategoryProgress(userData.checklist, category);
                    const categoryName = formatCategoryName(category);
                    
                    html += `
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-gray-500">${categoryName}</span>
                            <div class="flex items-center space-x-2">
                                <span class="font-medium">${categoryProgress.checked}/${categoryProgress.total}</span>
                                <div class="w-12 h-1 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-green-500 transition-all duration-300" 
                                         style="width: ${categoryProgress.total > 0 ? (categoryProgress.checked / categoryProgress.total) * 100 : 0}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            if (userNames.length === 0) {
                html = '<div class="col-span-full text-center text-gray-500">No group members yet.</div>';
            }
            
            groupDiv.innerHTML = html;
        }

        // Update detailed view
        function updateDetailedView() {
            const detailedDiv = document.getElementById('detailedView');
            const selectedCategory = document.getElementById('categoryFilter').value;
            
            let html = '';
            const categories = selectedCategory === 'all' ? Object.keys(packingItems) : [selectedCategory];
            const userNames = Object.keys(allUserData).sort();
            
            if (userNames.length === 0) {
                html = '<div class="text-center text-gray-500">No group members to compare yet.</div>';
            } else {
                categories.forEach(category => {
                    const categoryName = formatCategoryName(category);
                    
                    html += `
                        <div class="mb-8">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">${categoryName}</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b-2 border-gray-200">
                                            <th class="text-left py-3 px-4 font-medium">Item</th>
                    `;
                    
                    userNames.forEach(userName => {
                        const isCurrentUser = userName === currentUser;
                        const isOnline = allUserData[userName]?.isOnline;
                        html += `
                            <th class="text-center py-3 px-4 min-w-24 font-medium ${isCurrentUser ? 'text-blue-600' : ''}">
                                <div class="flex items-center justify-center space-x-1">
                                    <span>${userName}${isCurrentUser ? ' (You)' : ''}</span>
                                    <div class="w-2 h-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
                                </div>
                            </th>
                        `;
                    });
                    
                    html += `
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    packingItems[category].forEach(item => {
                        html += `
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-3 px-4">
                                    <div class="font-medium">${item.text}</div>
                                    ${item.note ? `<div class="text-xs text-blue-600 mt-1">${item.note}</div>` : ''}
                                </td>
                        `;
                        
                        userNames.forEach(userName => {
                            const isChecked = allUserData[userName]?.checklist?.[item.id] || false;
                            const isCurrentUser = userName === currentUser;
                            html += `
                                <td class="text-center py-3 px-4">
                                    <div class="inline-flex items-center justify-center w-8 h-8 rounded-full ${isChecked ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'} ${isCurrentUser ? 'ring-2 ring-blue-200' : ''}">
                                        ${isChecked ? 'âœ“' : 'â—‹'}
                                    </div>
                                </td>
                            `;
                        });
                        
                        html += `</tr>`;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
            }
            
            detailedDiv.innerHTML = html;
        }

        // Format category name
        function formatCategoryName(category) {
            const names = {
                'required': 'Required Items',
                'highlyRecommended':
